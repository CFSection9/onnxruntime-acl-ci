name: Build ONNX Runtime with ACL for Android

on:
  push:
    branches: [ main, develop ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  ANDROID_API_LEVEL: 24
  ANDROID_NDK_VERSION: r26b
  ANDROID_BUILD_TOOLS_VERSION: 34.0.0
  ANDROID_ABI: arm64-v8a

jobs:
  build-acl:
    name: Build ARM Compute Library (ACL)
    runs-on: ubuntu-latest
    outputs:
      acl-version: ${{ steps.get-acl-version.outputs.version }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get latest ACL version
        id: get-acl-version
        run: |
          # Fetch latest release from GitHub API
          LATEST_RELEASE=$(curl -s https://api.github.com/repos/ARM-software/ComputeLibrary/releases/latest | grep -oP '"tag_name": "\K[^"]+')
          ACL_VERSION=${LATEST_RELEASE#v}
          echo "version=${ACL_VERSION}" >> $GITHUB_OUTPUT
          echo "Downloading ACL version: ${ACL_VERSION}"

      - name: Cache ACL Build
        id: cache-acl
        uses: actions/cache@v3
        with:
          path: acl-build
          key: acl-android-${{ env.ANDROID_ABI }}-${{ steps.get-acl-version.outputs.version }}

      - name: Clone ARM Compute Library
        if: steps.cache-acl.outputs.cache-hit != 'true'
        run: |
          ACL_VERSION=${{ steps.get-acl-version.outputs.version }}
          echo "Cloning ACL version: v${ACL_VERSION}"
          git clone --depth 1 --branch v${ACL_VERSION} https://github.com/ARM-software/ComputeLibrary.git

      - name: Prepare ACL prebuilt for Android
        if: steps.cache-acl.outputs.cache-hit != 'true'
        run: |
          set -e
          ACL_VERSION=${{ steps.get-acl-version.outputs.version }}
          echo "Using ACL prebuilt for version: v${ACL_VERSION}"
          
          cd ComputeLibrary
          PREBUILT_TAR="arm_compute-v${ACL_VERSION}-android-aarch64-cpu-bin.tar.gz"
          PREBUILT_URL="https://github.com/ARM-software/ComputeLibrary/releases/download/v${ACL_VERSION}/${PREBUILT_TAR}"
          echo "Downloading prebuilt ACL from: ${PREBUILT_URL}"
          curl -L -o ${PREBUILT_TAR} ${PREBUILT_URL}
          mkdir -p ../acl-build/ComputeLibrary/build
          tar -xzf ${PREBUILT_TAR} -C ../acl-build/ComputeLibrary/build
          
          # Copy full source tree (excluding .git) so ORT can see src/* headers it expects
          mkdir -p ../acl-build/ComputeLibrary
          tar cf - --exclude='.git' . | (cd ../acl-build/ComputeLibrary && tar xf -)
          
          # Prebuilt contents already extracted into build/; ensure expected libs are present
          
          echo "Prebuilt artifacts and headers staged under ../acl-build/ComputeLibrary"
          ls -lah ../acl-build/ComputeLibrary
          ls -lah ../acl-build/ComputeLibrary/build
          
          echo ""
          echo "=== Looking for libarm_compute library files ==="
          find ../acl-build/ComputeLibrary -name "*libarm_compute*" -type f
          
          echo ""
          echo "=== All library files in staged build ==="
          find ../acl-build/ComputeLibrary -type f \( -name "*.a" -o -name "*.so" \) | head -20

      - name: Upload ACL Build Cache
        uses: actions/upload-artifact@v4
        with:
          name: acl-build-${{ env.ANDROID_ABI }}
          path: acl-build/
          retention-days: 7

  build-onnx-runtime:
    name: Build ONNX Runtime with ACL
    runs-on: ubuntu-latest
    needs: build-acl
    
    steps:
      - name: Checkout ONNX Runtime
        uses: actions/checkout@v4
        with:
          repository: microsoft/onnxruntime
          fetch-depth: 0

      - name: Get latest ONNX Runtime version
        id: get-ort-version
        run: |
          # Get latest stable release tag (format: v*.*.*)
          ORT_VERSION=$(git tag --sort=-version:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | head -1 | sed 's/^v//')
          echo "version=${ORT_VERSION}" >> $GITHUB_OUTPUT
          echo "Building ONNX Runtime version: ${ORT_VERSION}"
          
          # Checkout the specific release tag
          git checkout v${ORT_VERSION}

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: ${{ env.ANDROID_API_LEVEL }}
          ndk-version: ${{ env.ANDROID_NDK_VERSION }}
          build-tools-version: ${{ env.ANDROID_BUILD_TOOLS_VERSION }}

      - name: Download ACL Build
        uses: actions/download-artifact@v4
        with:
          name: acl-build-${{ env.ANDROID_ABI }}
          path: acl-build/

      - name: Verify ACL Build Contents
        run: |
          echo "=== Contents of acl-build/ ==="
          find acl-build -type f \( -name "*.so" -o -name "*.a" \) | head -20
          
          echo ""
          echo "=== Full directory listing ==="
          ls -lah acl-build/
          
          echo ""
          echo "=== Looking for libarm_compute files ==="
          find acl-build -name "*libarm_compute*" -type f

      - name: Build ONNX Runtime with ACL
        run: |
          cd $GITHUB_WORKSPACE

          # Find the directory containing libarm_compute.so and convert to absolute path
          ACL_LIB_PATH=$(find $GITHUB_WORKSPACE/acl-build/ComputeLibrary/build -name "libarm_compute.so" -type f | head -1 | xargs dirname)
          echo "Found ACL lib at: ${ACL_LIB_PATH}"
          ls -lah ${ACL_LIB_PATH}/

          # Build ONNX Runtime for Android with ACL
          python3 tools/ci_build/build.py \
            --build_dir build \
            --android \
            --android_sdk_path $ANDROID_SDK_ROOT \
            --android_ndk_path $ANDROID_NDK \
            --android_abi ${{ env.ANDROID_ABI }} \
            --use_acl \
            --acl_home $GITHUB_WORKSPACE/acl-build/ComputeLibrary \
            --acl_libs ${ACL_LIB_PATH} \
            --build_shared_lib \
            --config Release \
            --update \
            --build

      - name: Collect Build Artifacts
        run: |
          # Create organized artifact structure
          mkdir -p artifacts/{lib,include/onnxruntime,cmake}
          
          # Copy .so libraries
          echo "=== Collecting .so files ==="
          find build/Release -maxdepth 1 -name "libonnxruntime*.so" -type f -exec cp {} artifacts/lib/ \;
          ls -lah artifacts/lib/
          
          # Copy headers
          echo ""
          echo "=== Collecting headers ==="
          if [ -d "build/Release/onnxruntime_config.h" ]; then
            cp build/Release/onnxruntime_config.h artifacts/include/onnxruntime/
          fi
          find build -path "*include/onnxruntime*" -name "*.h" -type f -exec cp {} artifacts/include/onnxruntime/ \; 2>/dev/null || true
          find build -path "*include/onnxruntime*" -name "*.hpp" -type f -exec cp {} artifacts/include/onnxruntime/ \; 2>/dev/null || true
          ls -lah artifacts/include/onnxruntime/ | head -20
          
          # Copy CMake files
          echo ""
          echo "=== Collecting CMake files ==="
          find build -name "onnxruntimeTargets*.cmake" -type f -exec cp {} artifacts/cmake/ \;
          cp build/Release/CMakeCache.txt artifacts/cmake/ 2>/dev/null || true
          ls -lah artifacts/cmake/
          
          echo ""
          echo "=== Final artifacts structure ==="
          find artifacts -type f | head -30

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: onnxruntime-acl-android-${{ env.ANDROID_ABI }}
          path: artifacts/
          retention-days: 30

      - name: Create Release (on tag)
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: artifacts/lib/*.so
          draft: false
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') }}
          body: |
            ONNX Runtime built with ARM Compute Library (ACL) support for Android
            
            - ONNX Runtime: ${{ steps.get-ort-version.outputs.version }}
            - ACL Version: ${{ needs.build-acl.outputs.acl-version }}
            - Android API: ${{ env.ANDROID_API_LEVEL }}+
            - ABI: ${{ env.ANDROID_ABI }}
            
            `.so` files are included as release assets.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  verify-build:
    name: Verify Build Outputs
    runs-on: ubuntu-latest
    needs: build-onnx-runtime
    if: always()
    
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          name: onnxruntime-acl-android-${{ env.ANDROID_ABI }}

      - name: Verify .so files
        run: |
          echo "=== Artifact Structure ==="
          find . -type f | sort
          
          echo ""
          echo "=== .so Library Files ==="
          ls -lah lib/*.so 2>/dev/null || echo "No .so files found"
          
          echo ""
          echo "=== Headers ==="
          ls -lah include/onnxruntime/*.h 2>/dev/null | head -10 || echo "No headers found"
          
          echo ""
          echo "=== CMake Files ==="
          ls -lah cmake/ 2>/dev/null || echo "No cmake files found"
